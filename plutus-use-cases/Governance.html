<body ><h1 >Files</h1><ul ><li ><a href="#src/Plutus/Contracts/Governance.hs" >src/Plutus/Contracts/Governance.hs</a></li></ul><hr><h2 id="src/Plutus/Contracts/Governance.hs" >src/Plutus/Contracts/Governance.hs</h2><pre >.
.
.
    73    <span style=background-color:lightgray;color:gray >    deriving stock (Haskell.Eq, Haskell.Show, Generic)</span>
    74    <span style=background-color:lightgray;color:gray >    deriving anyclass (ToJSON, FromJSON)</span>
    75    <span style=background-color:lightgray;color:gray ></span>
    76    <span style=background-color:lightgray;color:gray >-- | The parameters for the proposal contract.</span>
    77    <span style=background-color:lightgray;color:gray >data Proposal = Proposal</span>
    78    <span style=background-color:lightgray;color:gray >    { </span><span style=background-color:black;color:orangered >newLaw </span><span style=background-color:lightgray;color:gray >        :: Law</span>
    79    <span style=background-color:lightgray;color:gray >    -- ^ The new contents of the law</span>
    80    <span style=background-color:lightgray;color:gray >    , tokenName      :: TokenName</span>
    81    <span style=background-color:lightgray;color:gray >    -- ^ The name of the voting tokens. Only voting token owners are allowed to propose changes.</span>
    82    <span style=background-color:lightgray;color:gray >    , </span><span style=background-color:white;color:black >votingDeadline </span><span style=background-color:lightgray;color:gray >:: POSIXTime</span>
    83    <span style=background-color:lightgray;color:gray >    -- ^ The time when voting ends and the votes are tallied.</span>
    84    <span style=background-color:lightgray;color:gray >    }</span>
    85    <span style=background-color:lightgray;color:gray >    deriving stock (Haskell.Show, Generic)</span>
    86    <span style=background-color:lightgray;color:gray >    deriving anyclass (ToJSON, FromJSON)</span>
    87    <span style=background-color:lightgray;color:gray ></span>
.
.
.
   144    <span style=background-color:lightgray;color:gray ></span>
   145    <span style=background-color:lightgray;color:gray >type GovernanceMachine = StateMachine GovState GovInput</span>
   146    <span style=background-color:lightgray;color:gray ></span>
   147    <span style=background-color:lightgray;color:gray >{-# INLINABLE machine #-}</span>
   148    <span style=background-color:lightgray;color:gray >machine :: Params -&gt; GovernanceMachine</span>
   149    <span style=background-color:white;color:black >machine params = SM.mkStateMachine </span><span style=background-color:white;color:black >Nothing </span><span style=background-color:white;color:black >(transition </span><span style=background-color:white;color:black >params)</span><span style=background-color:white;color:black > </span><span style=background-color:lightpink;color:black >isFinal </span><span style=background-color:white;color:black >where</span><span style=background-color:lightgray;color:gray ></span>
   150    <span style=background-color:white;color:black >    {-# INLINABLE isFinal #-}</span><span style=background-color:lightgray;color:gray ></span>
   151    <span style=background-color:white;color:black >    </span><span style=background-color:lightpink;color:black >isFinal _ = </span><span style=background-color:white;color:black >False</span><span style=background-color:lightgray;color:gray ></span>
   152    <span style=background-color:lightgray;color:gray ></span>
   153    <span style=background-color:lightgray;color:gray >{-# INLINABLE mkValidator #-}</span>
   154    <span style=background-color:lightgray;color:gray >mkValidator :: Params -&gt; Scripts.ValidatorType GovernanceMachine</span>
   155    <span style=background-color:white;color:black >mkValidator params = SM.mkValidator $ </span><span style=background-color:white;color:black >machine </span><span style=background-color:white;color:black >params</span><span style=background-color:lightgray;color:gray ></span>
   156    <span style=background-color:lightgray;color:gray ></span>
   157    <span style=background-color:lightgray;color:gray >typedValidator :: Params -&gt; Scripts.TypedValidator GovernanceMachine</span>
   158    <span style=background-color:lightgray;color:gray >typedValidator = Scripts.mkTypedValidatorParam @GovernanceMachine</span>
   159    <span style=background-color:lightgray;color:gray >    $$(PlutusTx.compile [|| mkValidator ||])</span>
   160    <span style=background-color:lightgray;color:gray >    $$(PlutusTx.compile [|| wrap ||])</span>
.
.
.
   168    <span style=background-color:lightgray;color:gray >mkTokenName :: TokenName -&gt; Integer -&gt; TokenName</span>
   169    <span style=background-color:lightgray;color:gray >mkTokenName base ix = fromString (Value.toString base ++ Haskell.show ix)</span>
   170    <span style=background-color:lightgray;color:gray ></span>
   171    <span style=background-color:lightgray;color:gray >{-# INLINABLE votingValue #-}</span>
   172    <span style=background-color:lightgray;color:gray >votingValue :: MintingPolicyHash -&gt; TokenName -&gt; Value.Value</span>
   173    <span style=background-color:white;color:black >votingValue mph tokenName =</span><span style=background-color:lightgray;color:gray ></span>
   174    <span style=background-color:white;color:black >    Value.singleton </span><span style=background-color:white;color:black >(Value.mpsSymbol mph) </span><span style=background-color:white;color:black >tokenName </span><span style=background-color:white;color:black >1</span><span style=background-color:lightgray;color:gray ></span>
   175    <span style=background-color:lightgray;color:gray ></span>
   176    <span style=background-color:lightgray;color:gray >{-# INLINABLE ownsVotingToken #-}</span>
   177    <span style=background-color:lightgray;color:gray >ownsVotingToken :: MintingPolicyHash -&gt; TokenName -&gt; TxConstraints Void Void</span>
   178    <span style=background-color:white;color:black >ownsVotingToken mph tokenName = Constraints.mustSpendAtLeast </span><span style=background-color:white;color:black >(votingValue </span><span style=background-color:white;color:black >mph </span><span style=background-color:white;color:black >tokenName)</span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   179    <span style=background-color:lightgray;color:gray ></span>
   180    <span style=background-color:lightgray;color:gray >{-# INLINABLE transition #-}</span>
   181    <span style=background-color:lightgray;color:gray >transition :: Params -&gt; State GovState -&gt; GovInput -&gt; Maybe (TxConstraints Void Void, State GovState)</span>
   182    <span style=background-color:white;color:black >transition Params{..} State{ stateData = s, stateValue} i = </span><span style=background-color:white;color:black >case (s, </span><span style=background-color:white;color:black >i)</span><span style=background-color:white;color:black > of</span><span style=background-color:lightgray;color:gray ></span>
   183    <span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   184    <span style=background-color:white;color:black >    (GovState{mph}, MintTokens tokenNames) -&gt;</span><span style=background-color:lightgray;color:gray ></span>
   185    <span style=background-color:white;color:black >        </span><span style=background-color:white;color:black >let (total, constraints) = </span><span style=background-color:white;color:black >foldMap</span><span style=background-color:lightgray;color:gray ></span>
   186    <span style=background-color:white;color:black >                </span><span style=background-color:white;color:black >(\(pk, nm) -&gt; </span><span style=background-color:white;color:black >let </span><span style=background-color:white;color:black >v = </span><span style=background-color:white;color:black >votingValue </span><span style=background-color:white;color:black >mph </span><span style=background-color:white;color:black >nm </span><span style=background-color:white;color:black >in (</span><span style=background-color:white;color:black >v,</span><span style=background-color:white;color:black > </span><span style=background-color:white;color:black >Constraints.mustPayToPubKey </span><span style=background-color:white;color:black >pk </span><span style=background-color:white;color:black >v)</span><span style=background-color:white;color:black >)</span><span style=background-color:white;color:black ></span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   187    <span style=background-color:white;color:black >                </span><span style=background-color:white;color:black >(zip </span><span style=background-color:white;color:black >initialHolders </span><span style=background-color:white;color:black >tokenNames)</span><span style=background-color:white;color:black ></span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   188    <span style=background-color:white;color:black >        in Just </span><span style=background-color:white;color:black >(</span><span style=background-color:white;color:black >constraints </span><span style=background-color:white;color:black >&lt;&gt; </span><span style=background-color:white;color:black >Constraints.mustMintValue </span><span style=background-color:white;color:black >total,</span><span style=background-color:white;color:black > </span><span style=background-color:white;color:black >State </span><span style=background-color:white;color:black >s </span><span style=background-color:white;color:black >stateValue)</span><span style=background-color:white;color:black ></span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   189    <span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   190    <span style=background-color:white;color:black >    (GovState law mph Nothing, ProposeChange proposal@Proposal{tokenName}) -&gt;</span><span style=background-color:lightgray;color:gray ></span>
   191    <span style=background-color:white;color:black >        </span><span style=background-color:white;color:black >let </span><span style=background-color:white;color:black >constraints = </span><span style=background-color:white;color:black >ownsVotingToken </span><span style=background-color:white;color:black >mph </span><span style=background-color:white;color:black >tokenName</span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   192    <span style=background-color:white;color:black >        in Just </span><span style=background-color:white;color:black >(</span><span style=background-color:white;color:black >constraints,</span><span style=background-color:white;color:black > </span><span style=background-color:white;color:black >State </span><span style=background-color:white;color:black >(GovState </span><span style=background-color:white;color:black >law </span><span style=background-color:white;color:black >mph </span><span style=background-color:white;color:black >(Just </span><span style=background-color:white;color:black >(Voting </span><span style=background-color:white;color:black >proposal </span><span style=background-color:white;color:black >AssocMap.empty)</span><span style=background-color:white;color:black >)</span><span style=background-color:white;color:black >)</span><span style=background-color:white;color:black > </span><span style=background-color:white;color:black >stateValue)</span><span style=background-color:white;color:black ></span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   193    <span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   194    <span style=background-color:white;color:black >    (GovState law mph (Just (Voting p oldMap)), AddVote tokenName vote) -&gt;</span><span style=background-color:lightgray;color:gray ></span>
   195    <span style=background-color:white;color:black >        </span><span style=background-color:white;color:black >let </span><span style=background-color:white;color:black >newMap = </span><span style=background-color:white;color:black >AssocMap.insert </span><span style=background-color:white;color:black >tokenName </span><span style=background-color:white;color:black >vote </span><span style=background-color:white;color:black >oldMap</span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   196    <span style=background-color:white;color:black >            -- Correct validity interval should be:</span><span style=background-color:lightgray;color:gray ></span>
   197    <span style=background-color:white;color:black >            -- @</span><span style=background-color:lightgray;color:gray ></span>
   198    <span style=background-color:white;color:black >            --   Interval (LowerBound NegInf True) (Interval.strictUpperBound $ votingDeadline p)</span><span style=background-color:lightgray;color:gray ></span>
   199    <span style=background-color:white;color:black >            -- @</span><span style=background-color:lightgray;color:gray ></span>
   200    <span style=background-color:white;color:black >            -- See Note [Validity Interval&#39;s upper bound</span><span style=background-color:lightgray;color:gray ></span>
   201    <span style=background-color:white;color:black >            </span><span style=background-color:white;color:black >validityTimeRange = </span><span style=background-color:white;color:black >Interval.to </span><span style=background-color:white;color:black >(</span><span style=background-color:white;color:black >votingDeadline p </span><span style=background-color:white;color:black >- </span><span style=background-color:white;color:black >2)</span><span style=background-color:white;color:black ></span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   202    <span style=background-color:white;color:black >            </span><span style=background-color:white;color:black >constraints = </span><span style=background-color:white;color:black >ownsVotingToken </span><span style=background-color:white;color:black >mph </span><span style=background-color:white;color:black >tokenName</span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   203    <span style=background-color:white;color:black >                        &lt;&gt; </span><span style=background-color:white;color:black >Constraints.mustValidateIn </span><span style=background-color:white;color:black >validityTimeRange</span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   204    <span style=background-color:white;color:black >        in Just </span><span style=background-color:white;color:black >(</span><span style=background-color:white;color:black >constraints,</span><span style=background-color:white;color:black > </span><span style=background-color:white;color:black >State </span><span style=background-color:white;color:black >(GovState </span><span style=background-color:white;color:black >law </span><span style=background-color:white;color:black >mph </span><span style=background-color:white;color:black >(Just </span><span style=background-color:white;color:black >(Voting </span><span style=background-color:white;color:black >p </span><span style=background-color:white;color:black >newMap)</span><span style=background-color:white;color:black >)</span><span style=background-color:white;color:black >)</span><span style=background-color:white;color:black > </span><span style=background-color:white;color:black >stateValue)</span><span style=background-color:white;color:black ></span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   205    <span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   206    <span style=background-color:white;color:black >    (GovState oldLaw mph (Just (Voting p votes)), FinishVoting) -&gt;</span><span style=background-color:lightgray;color:gray ></span>
   207    <span style=background-color:white;color:black >        </span><span style=background-color:white;color:black >let Sum ayes = </span><span style=background-color:white;color:black >foldMap </span><span style=background-color:black;color:orangered >(\b -&gt; Sum $ if b then </span><span style=background-color:black;color:orangered >1 </span><span style=background-color:black;color:orangered >else </span><span style=background-color:black;color:orangered >0)</span><span style=background-color:black;color:orangered > </span><span style=background-color:white;color:black >votes</span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   208    <span style=background-color:white;color:black >        in Just </span><span style=background-color:white;color:black >(</span><span style=background-color:white;color:black >mempty,</span><span style=background-color:white;color:black > </span><span style=background-color:white;color:black >State </span><span style=background-color:white;color:black >(GovState </span><span style=background-color:lightpink;color:black >(if </span><span style=background-color:white;color:black >ayes </span><span style=background-color:lightpink;color:black >&gt;= </span><span style=background-color:white;color:black >requiredVotes </span><span style=background-color:lightpink;color:black >then </span><span style=background-color:black;color:orangered >newLaw p </span><span style=background-color:lightpink;color:black >else </span><span style=background-color:white;color:black >oldLaw)</span><span style=background-color:lightpink;color:black > </span><span style=background-color:white;color:black >mph </span><span style=background-color:white;color:black >Nothing)</span><span style=background-color:white;color:black > </span><span style=background-color:white;color:black >stateValue)</span><span style=background-color:white;color:black ></span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   209    <span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   210    <span style=background-color:white;color:black >    _ -&gt; </span><span style=background-color:black;color:orangered >Nothing</span><span style=background-color:lightgray;color:gray ></span>
   211    <span style=background-color:lightgray;color:gray ></span>
   212    <span style=background-color:lightgray;color:gray >getLaw :: GovState -&gt; BuiltinByteString</span>
   213    <span style=background-color:lightgray;color:gray >getLaw (GovState (Law l) _ _) = l</span>
   214    <span style=background-color:lightgray;color:gray ></span>
   215    <span style=background-color:lightgray;color:gray >-- | The main contract for creating a new law and for voting on proposals.</span>
.
.
.
   257    <span style=background-color:lightgray;color:gray ></span>
   258    <span style=background-color:lightgray;color:gray >        logInfo @Text &quot;Voting finished. Counting the votes.&quot;</span>
   259    <span style=background-color:lightgray;color:gray >        void $ SM.runStep theClient FinishVoting</span>
   260    <span style=background-color:lightgray;color:gray ></span>
   261    <span style=background-color:lightgray;color:gray >PlutusTx.makeLift &#39;&#39;Params</span>
   262    <span style=background-color:white;color:black >PlutusTx.unstableMakeIsData &#39;&#39;Law</span><span style=background-color:lightgray;color:gray ></span>
   263    <span style=background-color:lightgray;color:gray >PlutusTx.makeLift &#39;&#39;Law</span>
   264    <span style=background-color:white;color:black >PlutusTx.unstableMakeIsData &#39;&#39;Proposal</span><span style=background-color:lightgray;color:gray ></span>
   265    <span style=background-color:lightgray;color:gray >PlutusTx.makeLift &#39;&#39;Proposal</span>
   266    <span style=background-color:white;color:black >PlutusTx.unstableMakeIsData &#39;&#39;Voting</span><span style=background-color:lightgray;color:gray ></span>
   267    <span style=background-color:lightgray;color:gray >PlutusTx.makeLift &#39;&#39;Voting</span>
   268    <span style=background-color:white;color:black >PlutusTx.unstableMakeIsData &#39;&#39;GovState</span><span style=background-color:lightgray;color:gray ></span>
   269    <span style=background-color:lightgray;color:gray >PlutusTx.makeLift &#39;&#39;GovState</span>
   270    <span style=background-color:lightgray;color:gray >PlutusTx.unstableMakeIsData &#39;&#39;GovInput</span>
   271    <span style=background-color:lightgray;color:gray >PlutusTx.makeLift &#39;&#39;GovInput</span>
   272    <span style=background-color:lightgray;color:gray ></span>
   273    <span style=background-color:lightgray;color:gray >covIdx :: CoverageIndex</span>
   274    <span style=background-color:lightgray;color:gray >covIdx =  getCovIdx $$(</span><span style=background-color:black;color:orangered >PlutusTx.compile [|| mkValidator ||])</span><span style=background-color:lightgray;color:gray ></span>
</pre></body>
<body ><h1 >Files</h1><ul ><li ><a href="#src/Plutus/Contracts/Governance.hs" >src/Plutus/Contracts/Governance.hs</a></li></ul><hr><h2 id="src/Plutus/Contracts/Governance.hs" >src/Plutus/Contracts/Governance.hs</h2><pre >.
.
.
    71    <span style=background-color:lightgray;color:gray >-- * Holders of those tokens can propose changes to the state of the contract and vote on them.</span>
    72    <span style=background-color:lightgray;color:gray >-- * After a certain period of time the voting ends and the proposal is rejected or accepted.</span>
    73    <span style=background-color:lightgray;color:gray ></span>
    74    <span style=background-color:lightgray;color:gray >-- | The parameters for the proposal contract.</span>
    75    <span style=background-color:lightgray;color:gray >data Proposal = Proposal</span>
    76    <span style=background-color:lightgray;color:gray >    { </span><span style=background-color:black;color:orangered >newLaw </span><span style=background-color:lightgray;color:gray >        :: BuiltinByteString</span>
    77    <span style=background-color:lightgray;color:gray >    -- ^ The new contents of the law</span>
    78    <span style=background-color:lightgray;color:gray >    , tokenName      :: TokenName</span>
    79    <span style=background-color:lightgray;color:gray >    -- ^ The name of the voting tokens. Only voting token owners are allowed to propose changes.</span>
    80    <span style=background-color:lightgray;color:gray >    , </span><span style=background-color:black;color:orangered >votingDeadline </span><span style=background-color:lightgray;color:gray >:: POSIXTime</span>
    81    <span style=background-color:lightgray;color:gray >    -- ^ The time when voting ends and the votes are tallied.</span>
    82    <span style=background-color:lightgray;color:gray >    }</span>
    83    <span style=background-color:lightgray;color:gray >    deriving stock (Haskell.Show, Generic)</span>
    84    <span style=background-color:lightgray;color:gray >    deriving anyclass (ToJSON, FromJSON)</span>
    85    <span style=background-color:lightgray;color:gray ></span>
.
.
.
   140    <span style=background-color:lightgray;color:gray ></span>
   141    <span style=background-color:lightgray;color:gray >type GovernanceMachine = StateMachine GovState GovInput</span>
   142    <span style=background-color:lightgray;color:gray ></span>
   143    <span style=background-color:lightgray;color:gray >{-# INLINABLE machine #-}</span>
   144    <span style=background-color:lightgray;color:gray >machine :: Params -&gt; GovernanceMachine</span>
   145    <span style=background-color:white;color:black >machine params = SM.mkStateMachine Nothing (transition params) </span><span style=background-color:lightpink;color:black >isFinal </span><span style=background-color:white;color:black >where</span><span style=background-color:lightgray;color:gray ></span>
   146    <span style=background-color:white;color:black >    {-# INLINABLE isFinal #-}</span><span style=background-color:lightgray;color:gray ></span>
   147    <span style=background-color:white;color:black >    </span><span style=background-color:lightpink;color:black >isFinal _ = False</span><span style=background-color:lightgray;color:gray ></span>
   148    <span style=background-color:lightgray;color:gray ></span>
   149    <span style=background-color:lightgray;color:gray >{-# INLINABLE mkValidator #-}</span>
   150    <span style=background-color:lightgray;color:gray >mkValidator :: Params -&gt; Scripts.ValidatorType GovernanceMachine</span>
   151    <span style=background-color:white;color:black >mkValidator params = SM.mkValidator $ machine params</span><span style=background-color:lightgray;color:gray ></span>
   152    <span style=background-color:lightgray;color:gray ></span>
   153    <span style=background-color:lightgray;color:gray >typedValidator :: Params -&gt; Scripts.TypedValidator GovernanceMachine</span>
   154    <span style=background-color:lightgray;color:gray >typedValidator = Scripts.mkTypedValidatorParam @GovernanceMachine</span>
   155    <span style=background-color:lightgray;color:gray >    $$(PlutusTx.compile [|| mkValidator ||])</span>
   156    <span style=background-color:lightgray;color:gray >    $$(PlutusTx.compile [|| wrap ||])</span>
.
.
.
   164    <span style=background-color:lightgray;color:gray >mkTokenName :: TokenName -&gt; Integer -&gt; TokenName</span>
   165    <span style=background-color:lightgray;color:gray >mkTokenName base ix = fromString (Value.toString base ++ Haskell.show ix)</span>
   166    <span style=background-color:lightgray;color:gray ></span>
   167    <span style=background-color:lightgray;color:gray >{-# INLINABLE votingValue #-}</span>
   168    <span style=background-color:lightgray;color:gray >votingValue :: MintingPolicyHash -&gt; TokenName -&gt; Value.Value</span>
   169    <span style=background-color:white;color:black >votingValue mph tokenName =</span><span style=background-color:lightgray;color:gray ></span>
   170    <span style=background-color:white;color:black >    Value.singleton (Value.mpsSymbol mph) tokenName 1</span><span style=background-color:lightgray;color:gray ></span>
   171    <span style=background-color:lightgray;color:gray ></span>
   172    <span style=background-color:lightgray;color:gray >{-# INLINABLE ownsVotingToken #-}</span>
   173    <span style=background-color:lightgray;color:gray >ownsVotingToken :: MintingPolicyHash -&gt; TokenName -&gt; TxConstraints Void Void</span>
   174    <span style=background-color:white;color:black >ownsVotingToken mph tokenName = Constraints.mustSpendAtLeast (votingValue mph tokenName)</span><span style=background-color:lightgray;color:gray ></span>
   175    <span style=background-color:lightgray;color:gray ></span>
   176    <span style=background-color:lightgray;color:gray >{-# INLINABLE transition #-}</span>
   177    <span style=background-color:lightgray;color:gray >transition :: Params -&gt; State GovState -&gt; GovInput -&gt; Maybe (TxConstraints Void Void, State GovState)</span>
   178    <span style=background-color:white;color:black >transition Params{..} State{ stateData = s, stateValue} i = case (s, i) of</span><span style=background-color:lightgray;color:gray ></span>
   179    <span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   180    <span style=background-color:white;color:black >    (GovState{mph}, MintTokens tokenNames) -&gt;</span><span style=background-color:lightgray;color:gray ></span>
   181    <span style=background-color:white;color:black >        let (total, constraints) = foldMap</span><span style=background-color:lightgray;color:gray ></span>
   182    <span style=background-color:white;color:black >                (\(pk, nm) -&gt; let v = votingValue mph nm in (v, Constraints.mustPayToPubKey pk v))</span><span style=background-color:lightgray;color:gray ></span>
   183    <span style=background-color:white;color:black >                (zip initialHolders tokenNames)</span><span style=background-color:lightgray;color:gray ></span>
   184    <span style=background-color:white;color:black >        in Just (constraints &lt;&gt; Constraints.mustMintValue total, State s stateValue)</span><span style=background-color:lightgray;color:gray ></span>
   185    <span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   186    <span style=background-color:white;color:black >    (GovState law mph Nothing, ProposeChange proposal@Proposal{tokenName}) -&gt;</span><span style=background-color:lightgray;color:gray ></span>
   187    <span style=background-color:white;color:black >        let constraints = ownsVotingToken mph tokenName</span><span style=background-color:lightgray;color:gray ></span>
   188    <span style=background-color:white;color:black >        in Just (constraints, State (GovState law mph (Just (Voting proposal AssocMap.empty))) stateValue)</span><span style=background-color:lightgray;color:gray ></span>
   189    <span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   190    <span style=background-color:white;color:black >    (GovState law mph (Just (Voting p oldMap)), AddVote tokenName vote) -&gt;</span><span style=background-color:lightgray;color:gray ></span>
   191    <span style=background-color:white;color:black >        </span><span style=background-color:black;color:orangered >let </span><span style=background-color:black;color:orangered >newMap = </span><span style=background-color:black;color:orangered >AssocMap.insert </span><span style=background-color:black;color:orangered >tokenName </span><span style=background-color:black;color:orangered >vote </span><span style=background-color:black;color:orangered >oldMap</span><span style=background-color:black;color:orangered ></span><span style=background-color:lightgray;color:gray ></span>
   192    <span style=background-color:black;color:orangered >            </span><span style=background-color:black;color:orangered >constraints = </span><span style=background-color:black;color:orangered >ownsVotingToken </span><span style=background-color:black;color:orangered >mph </span><span style=background-color:black;color:orangered >tokenName</span><span style=background-color:black;color:orangered ></span><span style=background-color:lightgray;color:gray ></span>
   193    <span style=background-color:black;color:orangered >                        &lt;&gt; </span><span style=background-color:black;color:orangered >Constraints.mustValidateIn </span><span style=background-color:black;color:orangered >(Interval.to </span><span style=background-color:black;color:orangered >(votingDeadline p))</span><span style=background-color:black;color:orangered ></span><span style=background-color:black;color:orangered ></span><span style=background-color:lightgray;color:gray ></span>
   194    <span style=background-color:black;color:orangered >        in Just </span><span style=background-color:black;color:orangered >(</span><span style=background-color:black;color:orangered >constraints,</span><span style=background-color:black;color:orangered > </span><span style=background-color:black;color:orangered >State </span><span style=background-color:black;color:orangered >(GovState </span><span style=background-color:black;color:orangered >law </span><span style=background-color:black;color:orangered >mph </span><span style=background-color:black;color:orangered >(Just </span><span style=background-color:black;color:orangered >(Voting </span><span style=background-color:black;color:orangered >p </span><span style=background-color:black;color:orangered >newMap)</span><span style=background-color:black;color:orangered >)</span><span style=background-color:black;color:orangered >)</span><span style=background-color:black;color:orangered > </span><span style=background-color:black;color:orangered >stateValue)</span><span style=background-color:black;color:orangered ></span><span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   195    <span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   196    <span style=background-color:white;color:black >    (GovState oldLaw mph (Just (Voting p votes)), FinishVoting) -&gt;</span><span style=background-color:lightgray;color:gray ></span>
   197    <span style=background-color:white;color:black >        let Sum ayes = foldMap </span><span style=background-color:black;color:orangered >(\b -&gt; Sum $ if b then </span><span style=background-color:black;color:orangered >1 </span><span style=background-color:black;color:orangered >else </span><span style=background-color:black;color:orangered >0)</span><span style=background-color:black;color:orangered > </span><span style=background-color:white;color:black >votes</span><span style=background-color:lightgray;color:gray ></span>
   198    <span style=background-color:white;color:black >        in Just (mempty, State (GovState </span><span style=background-color:lightpink;color:black >(if ayes &gt;= requiredVotes then </span><span style=background-color:black;color:orangered >newLaw p </span><span style=background-color:lightpink;color:black >else oldLaw) </span><span style=background-color:white;color:black >mph Nothing) stateValue)</span><span style=background-color:lightgray;color:gray ></span>
   199    <span style=background-color:white;color:black ></span><span style=background-color:lightgray;color:gray ></span>
   200    <span style=background-color:white;color:black >    _ -&gt; </span><span style=background-color:black;color:orangered >Nothing</span><span style=background-color:lightgray;color:gray ></span>
   201    <span style=background-color:lightgray;color:gray ></span>
   202    <span style=background-color:lightgray;color:gray >-- | The main contract for creating a new law and for voting on proposals.</span>
   203    <span style=background-color:lightgray;color:gray >contract ::</span>
   204    <span style=background-color:lightgray;color:gray >    AsGovError e</span>
   205    <span style=background-color:lightgray;color:gray >    =&gt; Params</span>
.
.
.
   233    <span style=background-color:lightgray;color:gray ></span>
   234    <span style=background-color:lightgray;color:gray >        logInfo @Text &quot;Voting finished. Counting the votes.&quot;</span>
   235    <span style=background-color:lightgray;color:gray >        void $ SM.runStep theClient FinishVoting</span>
   236    <span style=background-color:lightgray;color:gray ></span>
   237    <span style=background-color:lightgray;color:gray >PlutusTx.makeLift &#39;&#39;Params</span>
   238    <span style=background-color:white;color:black >PlutusTx.unstableMakeIsData &#39;&#39;Proposal</span><span style=background-color:lightgray;color:gray ></span>
   239    <span style=background-color:lightgray;color:gray >PlutusTx.makeLift &#39;&#39;Proposal</span>
   240    <span style=background-color:white;color:black >PlutusTx.unstableMakeIsData &#39;&#39;Voting</span><span style=background-color:lightgray;color:gray ></span>
   241    <span style=background-color:lightgray;color:gray >PlutusTx.makeLift &#39;&#39;Voting</span>
   242    <span style=background-color:white;color:black >PlutusTx.unstableMakeIsData &#39;&#39;GovState</span><span style=background-color:lightgray;color:gray ></span>
   243    <span style=background-color:lightgray;color:gray >PlutusTx.makeLift &#39;&#39;GovState</span>
   244    <span style=background-color:lightgray;color:gray >PlutusTx.unstableMakeIsData &#39;&#39;GovInput</span>
   245    <span style=background-color:lightgray;color:gray >PlutusTx.makeLift &#39;&#39;GovInput</span>
   246    <span style=background-color:lightgray;color:gray ></span>
   247    <span style=background-color:lightgray;color:gray >covIdx :: CoverageIndex</span>
   248    <span style=background-color:lightgray;color:gray >covIdx = getCovIdx $$(</span><span style=background-color:black;color:orangered >PlutusTx.compile [|| mkValidator ||])</span><span style=background-color:lightgray;color:gray ></span>
</pre></body>
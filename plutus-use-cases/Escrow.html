<body ><h1 >Files</h1><ul ><li ><a href="#src/Plutus/Contracts/Escrow.hs" >src/Plutus/Contracts/Escrow.hs</a></li></ul><hr><h2 id="src/Plutus/Contracts/Escrow.hs" >src/Plutus/Contracts/Escrow.hs</h2><pre >.
.
.
   174    <span style=background-color:lightgray;color:gray >data Escrow</span>
   175    <span style=background-color:lightgray;color:gray >instance Scripts.ValidatorTypes Escrow where</span>
   176    <span style=background-color:lightgray;color:gray >    type instance RedeemerType Escrow = Action</span>
   177    <span style=background-color:lightgray;color:gray >    type instance DatumType Escrow = PaymentPubKeyHash</span>
   178    <span style=background-color:lightgray;color:gray ></span>
   179    <span style=background-color:black;color:orangered >PlutusTx.unstableMakeIsData &#39;&#39;Action</span><span style=background-color:lightgray;color:gray ></span>
   180    <span style=background-color:lightgray;color:gray >PlutusTx.makeLift &#39;&#39;Action</span>
   181    <span style=background-color:lightgray;color:gray ></span>
   182    <span style=background-color:lightgray;color:gray >{-# INLINABLE meetsTarget #-}</span>
   183    <span style=background-color:lightgray;color:gray >-- | @ptx `meetsTarget` tgt@ if @ptx@ pays at least @targetValue tgt@ to the</span>
   184    <span style=background-color:lightgray;color:gray >--   target address.</span>
   185    <span style=background-color:lightgray;color:gray >--</span>
   186    <span style=background-color:lightgray;color:gray >--   The reason why this does not require the target amount to be equal</span>
   187    <span style=background-color:lightgray;color:gray >--   to the actual amount is to enable any excess funds consumed by the</span>
   188    <span style=background-color:lightgray;color:gray >--   spending transaction to be paid to target addresses. This may happen if</span>
   189    <span style=background-color:lightgray;color:gray >--   the target address is also used as a change address for the spending</span>
   190    <span style=background-color:lightgray;color:gray >--   transaction, and allowing the target to be exceed prevents outsiders from</span>
   191    <span style=background-color:lightgray;color:gray >--   poisoning the contract by adding arbitrary outputs to the script address.</span>
   192    <span style=background-color:lightgray;color:gray >meetsTarget :: TxInfo -&gt; EscrowTarget DatumHash -&gt; Bool</span>
   193    <span style=background-color:black;color:orangered >meetsTarget ptx = \case</span><span style=background-color:lightgray;color:gray ></span>
   194    <span style=background-color:black;color:orangered >    PaymentPubKeyTarget pkh vl -&gt;</span><span style=background-color:lightgray;color:gray ></span>
   195    <span style=background-color:black;color:orangered >        </span><span style=background-color:black;color:orangered >valuePaidTo </span><span style=background-color:black;color:orangered >ptx </span><span style=background-color:black;color:orangered >(unPaymentPubKeyHash pkh) </span><span style=background-color:black;color:orangered >`geq` </span><span style=background-color:black;color:orangered >vl</span><span style=background-color:black;color:orangered ></span><span style=background-color:lightgray;color:gray ></span>
   196    <span style=background-color:black;color:orangered >    ScriptTarget validatorHash dataValue vl -&gt;</span><span style=background-color:lightgray;color:gray ></span>
   197    <span style=background-color:black;color:orangered >        </span><span style=background-color:black;color:orangered >case scriptOutputsAt </span><span style=background-color:black;color:orangered >validatorHash </span><span style=background-color:black;color:orangered >ptx </span><span style=background-color:black;color:orangered >of</span><span style=background-color:lightgray;color:gray ></span>
   198    <span style=background-color:black;color:orangered >            [(dataValue&#39;, vl&#39;)] -&gt;</span><span style=background-color:lightgray;color:gray ></span>
   199    <span style=background-color:black;color:orangered >                </span><span style=background-color:black;color:orangered >traceIfFalse </span><span style=background-color:black;color:orangered >&quot;dataValue&quot; </span><span style=background-color:black;color:orangered >(</span><span style=background-color:black;color:orangered >dataValue&#39; </span><span style=background-color:black;color:orangered >== </span><span style=background-color:black;color:orangered >dataValue)</span><span style=background-color:black;color:orangered ></span><span style=background-color:lightgray;color:gray ></span>
   200    <span style=background-color:black;color:orangered >                &amp;&amp; </span><span style=background-color:black;color:orangered >traceIfFalse </span><span style=background-color:black;color:orangered >&quot;value&quot; </span><span style=background-color:black;color:orangered >(</span><span style=background-color:black;color:orangered >vl&#39; </span><span style=background-color:black;color:orangered >`geq` </span><span style=background-color:black;color:orangered >vl)</span><span style=background-color:black;color:orangered ></span><span style=background-color:black;color:orangered ></span><span style=background-color:lightgray;color:gray ></span>
   201    <span style=background-color:black;color:orangered >            _ -&gt; </span><span style=background-color:black;color:orangered >False</span><span style=background-color:lightgray;color:gray ></span>
   202    <span style=background-color:lightgray;color:gray ></span>
   203    <span style=background-color:lightgray;color:gray >{-# INLINABLE validate #-}</span>
   204    <span style=background-color:lightgray;color:gray >validate :: EscrowParams DatumHash -&gt; PaymentPubKeyHash -&gt; Action -&gt; ScriptContext -&gt; Bool</span>
   205    <span style=background-color:black;color:orangered >validate EscrowParams{escrowDeadline, escrowTargets} contributor action ScriptContext{scriptContextTxInfo} =</span><span style=background-color:lightgray;color:gray ></span>
   206    <span style=background-color:black;color:orangered >    </span><span style=background-color:black;color:orangered >case action of</span><span style=background-color:lightgray;color:gray ></span>
   207    <span style=background-color:black;color:orangered >        Redeem -&gt;</span><span style=background-color:lightgray;color:gray ></span>
   208    <span style=background-color:black;color:orangered >            </span><span style=background-color:black;color:orangered >traceIfFalse </span><span style=background-color:black;color:orangered >&quot;escrowDeadline-after&quot; </span><span style=background-color:black;color:orangered >(</span><span style=background-color:black;color:orangered >escrowDeadline </span><span style=background-color:black;color:orangered >`after` txInfoValidRange scriptContextTxInfo)</span><span style=background-color:lightgray;color:gray ></span>
   209    <span style=background-color:black;color:orangered >            &amp;&amp; </span><span style=background-color:black;color:orangered >traceIfFalse </span><span style=background-color:black;color:orangered >&quot;meetsTarget&quot; </span><span style=background-color:black;color:orangered >(all </span><span style=background-color:black;color:orangered >(meetsTarget </span><span style=background-color:black;color:orangered >scriptContextTxInfo)</span><span style=background-color:black;color:orangered > </span><span style=background-color:black;color:orangered >escrowTargets)</span><span style=background-color:black;color:orangered ></span><span style=background-color:black;color:orangered ></span><span style=background-color:lightgray;color:gray ></span>
   210    <span style=background-color:black;color:orangered >        Refund -&gt;</span><span style=background-color:lightgray;color:gray ></span>
   211    <span style=background-color:black;color:orangered >            </span><span style=background-color:black;color:orangered >traceIfFalse </span><span style=background-color:black;color:orangered >&quot;escrowDeadline-before&quot; </span><span style=background-color:black;color:orangered >(</span><span style=background-color:black;color:orangered >(</span><span style=background-color:black;color:orangered >escrowDeadline </span><span style=background-color:black;color:orangered >- </span><span style=background-color:black;color:orangered >1)</span><span style=background-color:black;color:orangered > </span><span style=background-color:black;color:orangered >`before` </span><span style=background-color:black;color:orangered >txInfoValidRange scriptContextTxInfo)</span><span style=background-color:black;color:orangered ></span><span style=background-color:lightgray;color:gray ></span>
   212    <span style=background-color:black;color:orangered >            &amp;&amp; </span><span style=background-color:black;color:orangered >traceIfFalse </span><span style=background-color:black;color:orangered >&quot;txSignedBy&quot; </span><span style=background-color:black;color:orangered >(</span><span style=background-color:black;color:orangered >scriptContextTxInfo </span><span style=background-color:black;color:orangered >`txSignedBy` </span><span style=background-color:black;color:orangered >unPaymentPubKeyHash contributor)</span><span style=background-color:black;color:orangered ></span><span style=background-color:lightgray;color:gray ></span>
   213    <span style=background-color:lightgray;color:gray ></span>
   214    <span style=background-color:lightgray;color:gray ></span>
   215    <span style=background-color:lightgray;color:gray >-- We can use &#39;compile&#39; to turn a validator function into a compiled Plutus Core program.</span>
   216    <span style=background-color:lightgray;color:gray >-- Here&#39;s a reminder of how to do it.</span>
   217    <span style=background-color:lightgray;color:gray >compiledValidator :: CompiledCode (EscrowParams DatumHash -&gt; PaymentPubKeyHash -&gt; Action -&gt; ScriptContext -&gt; Bool)</span>
.
.
.
   384    <span style=background-color:lightgray;color:gray >    -- Pay the value &#39;vl&#39; into the contract</span>
   385    <span style=background-color:lightgray;color:gray >    _ &lt;- pay inst params vl</span>
   386    <span style=background-color:lightgray;color:gray >    go</span>
   387    <span style=background-color:lightgray;color:gray ></span>
   388    <span style=background-color:lightgray;color:gray >covIdx :: CoverageIndex</span>
   389    <span style=background-color:lightgray;color:gray >covIdx = getCovIdx $$(</span><span style=background-color:black;color:orangered >PlutusTx.compile [|| validate ||])</span><span style=background-color:lightgray;color:gray ></span>
   390    <span style=background-color:lightgray;color:gray >      &lt;&gt; getCovIdx $$(</span><span style=background-color:black;color:orangered >PlutusTx.compile [|| wrap ||])</span><span style=background-color:lightgray;color:gray ></span>
   391    <span style=background-color:lightgray;color:gray >  where</span>
   392    <span style=background-color:lightgray;color:gray >    wrap :: (PaymentPubKeyHash -&gt; Action -&gt; ScriptContext -&gt; Bool) -&gt;</span>
   393    <span style=background-color:lightgray;color:gray >            Scripts.UntypedValidator</span>
   394    <span style=background-color:lightgray;color:gray >    </span><span style=background-color:black;color:orangered >wrap = </span><span style=background-color:black;color:orangered >Scripts.mkUntypedValidator</span><span style=background-color:lightgray;color:gray ></span>
</pre></body>